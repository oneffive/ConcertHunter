{% extends 'events/base.html' %}

{% block head %}
    {{ block.super }} 
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 400px; width: 100%; border-radius: 10px; margin-bottom: 20px;}
    </style>
{% endblock %}  

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <h1 class="text-center">–ú–æ–∏ –∫–æ–Ω—Ü–µ—Ä—Ç—ã</h1>
    </div>
    <div class="col-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">–í–∞—à–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ ({{ subscriptions.count }})</h5>
            </div>
            <div class="card-body p-0">
                {% if subscriptions %}
                    <div class="list-group list-group-flush">
                        <div class="list-group list-group-flush">
                            {% for sub in subscriptions %}
                            <div class="list-group-item">
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        {% if sub.artist.image_url %}
                                            <img src="{{ sub.artist.image_url }}" alt="{{ sub.artist.name }}" 
                                                style="width: 40px; height: 30px; object-fit: cover; border-radius: 4px; margin-right: 10px;">
                                        {% endif %}
                                        <div>
                                            <strong>{{ sub.artist.name }}</strong>
                                            <span class="badge bg-secondary ms-2">{{ sub.city }}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        
                                        <a href="{% url 'city_events' sub.city %}" class="btn btn-outline-primary btn-sm" title="–í—Å–µ —Å–æ–±—ã—Ç–∏—è –≤ {{ sub.city }}">
                                             –ê—Ñ–∏—à–∞ –≥–æ—Ä–æ–¥–∞
                                        </a>
                                        
                                        
                                        <form action="{% url 'delete_subscription' sub.id %}" method="post" onsubmit="return confirm('–¢–æ—á–Ω–æ –æ—Ç–ø–∏—Å–∞—Ç—å—Å—è?');">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-outline-danger btn-sm">X</button>
                                        </form>
                                    </div>
                                </div>

                                
                                <div class="mt-1">
                                <small class="text-muted" style="font-size: 0.8rem;">
                                    –ù–µ—Ç –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤ –∞—Ä—Ç–∏—Å—Ç–∞? –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ <a href="{% url 'city_events' sub.city %}">–¥—Ä—É–≥–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ {{ sub.city }}</a>.
                                </small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <div class="p-3 text-muted text-center">
                        –í—ã –ø–æ–∫–∞ –Ω–∏ –Ω–∞ –∫–æ–≥–æ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã. <a href="{% url 'search' %}">–ù–∞–π—Ç–∏ –∞—Ä—Ç–∏—Å—Ç–æ–≤</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    
    <div class="col-12 mb-5">
        <div id="map"></div>
    </div>

    
    <div class="col-12">
        {% if events %}
            <div class="row">
                {% for event in events %}
<div class="col-md-6 col-lg-4 mb-4">
    
    <div class="card h-100 shadow-sm position-relative">
        
        
        <form action="{% url 'delete_event' event.id %}" method="post" style="position: absolute; top: 10px; right: 10px; z-index: 10;">
            {% csrf_token %}
            
            <button type="submit" class="btn-close" aria-label="Close" 
                    onclick="return confirm('–°–∫—Ä—ã—Ç—å —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ?');" 
                    title="–£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ"></button>
        </form>
        

        <div class="card-body">
            <h5 class="card-title pe-4">{{ event.artist.name }}</h5>
            <h6 class="card-subtitle mb-2 text-muted">{{ event.name }}</h6>
            <p class="card-text">
                üìÖ {{ event.date|date:"d M Y H:i" }}<br>
                üìç {{ event.venue_name }}, {{ event.city }}
            </p>
            <a href="{{ event.ticket_url }}" target="_blank" class="btn btn-primary btn-sm">–ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç</a>
        </div>
    </div>
</div>
{% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info text-center">
                –ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤ –ø–æ –≤–∞—à–∏–º –ø–æ–¥–ø–∏—Å–∫–∞–º. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ block.super }} 
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var eventsData = {{ map_data_json|safe }}; 

        if (eventsData.length > 0) {
            
            var initialLat = eventsData[0].lat;
            var initialLon = eventsData[0].lon;
            var map = L.map('map').setView([initialLat, initialLon], 5); 
            
            
            var latLngs = eventsData.map(e => [e.lat, e.lon]);
            if (latLngs.length > 1) {
                map.fitBounds(latLngs);
            }

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            eventsData.forEach(function(event) {
                L.marker([event.lat, event.lon])
                    .addTo(map)
                    .bindPopup(
                        `<b>${event.title}</b><br>` +
                        `–î–∞—Ç–∞: ${event.date}<br>` +
                        `–ú–µ—Å—Ç–æ: ${event.venue}<br>` +
                        `<a href="${event.ticket_url}" target="_blank">–ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç</a>`
                    );
            });
        } else {
            
            var map = L.map('map').setView([0, 0], 2); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            L.marker([51.5, -0.09]).addTo(map).bindPopup("–ù–µ—Ç –∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤? –î–æ–±–∞–≤—å –ø–æ–¥–ø–∏—Å–∫—É");
        }
    </script>
{% endblock %}