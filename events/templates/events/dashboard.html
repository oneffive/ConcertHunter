{% extends 'events/base.html' %}

{% block head %}
    {{ block.super }} 
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 400px; width: 100%; border-radius: 10px; margin-bottom: 20px;}
    </style>
{% endblock %}  

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <h1 class="text-center">Мои концерты</h1>
    </div>

    
    <div class="col-12 mb-5">
        <div id="map"></div>
    </div>

    
    <div class="col-12">
        {% if events %}
            <div class="row">
                {% for event in events %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">{{ event.artist.name }}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">{{ event.name }}</h6>
                            <p class="card-text">
                                 {{ event.date|date:"d M Y H:i" }}<br>
                                 {{ event.venue_name }}, {{ event.city }}
                            </p>
                            <a href="{{ event.ticket_url }}" target="_blank" class="btn btn-primary btn-sm">Купить билет</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info text-center">
                Пока нет предстоящих концертов по вашим подпискам. Добавьте новые
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ block.super }} 
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var eventsData = {{ map_data_json|safe }}; 

        if (eventsData.length > 0) {
            
            var initialLat = eventsData[0].lat;
            var initialLon = eventsData[0].lon;
            var map = L.map('map').setView([initialLat, initialLon], 5); 
            
            
            var latLngs = eventsData.map(e => [e.lat, e.lon]);
            if (latLngs.length > 1) {
                map.fitBounds(latLngs);
            }

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            eventsData.forEach(function(event) {
                L.marker([event.lat, event.lon])
                    .addTo(map)
                    .bindPopup(
                        `<b>${event.title}</b><br>` +
                        `Дата: ${event.date}<br>` +
                        `Место: ${event.venue}<br>` +
                        `<a href="${event.ticket_url}" target="_blank">Купить билет</a>`
                    );
            });
        } else {
            
            var map = L.map('map').setView([0, 0], 2); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            L.marker([51.5, -0.09]).addTo(map).bindPopup("Нет концертов? Добавь подписку");
        }
    </script>
{% endblock %}